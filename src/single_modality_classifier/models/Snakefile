configfile: './config.yaml'

all_cancers = config['cancers']
joined_cancers = '_'.join(config['cancers'])
run_iterations = range(0, config['run_iterations'])
modalities = ["rna", "annotations", "mutations", "images"]

# (optional) passthroughs if you keep these in config
batch_size = int(config.get("batch_size", 32))
_seed = config.get("seed", None)
seed_opt = f"--seed {_seed}" if _seed is not None else ""

# ---- aggregate targets over modalities Ã— iterations ----
rule all:
    input:
        expand(
            "results/single_modality_classifier/classification/{cancers}/{modality}/{iteration}/history.csv",
            cancers=[joined_cancers], modality=modalities, iteration=run_iterations
        ),
        expand(
            "results/single_modality_classifier/classification/{cancers}/{modality}/{iteration}/results.csv",
            cancers=[joined_cancers], modality=modalities, iteration=run_iterations
        ),
        expand(
            "results/single_modality_classifier/classification/{cancers}/{modality}/{iteration}/predictions.csv",
            cancers=[joined_cancers], modality=modalities, iteration=run_iterations
        )

# ---- one job per {modality, iteration}; Snakemake will schedule concurrently with -j ----
rule run_classification:
    input:
        # H5 produced by your single-modality embedding generator
        "results/single_modality_classifier/summed_embeddings/{cancers}/{modality}_embeddings.h5"
    output:
        "results/single_modality_classifier/classification/{cancers}/{modality}/{iteration}/history.csv",
        "results/single_modality_classifier/classification/{cancers}/{modality}/{iteration}/results.csv",
        "results/single_modality_classifier/classification/{cancers}/{modality}/{iteration}/predictions.csv"
    params:
        cancers=" ".join(all_cancers),
        modality=lambda wc: wc.modality,
        iteration=lambda wc: wc.iteration,
        batch_size=batch_size,
        seed_opt=seed_opt
    shell:
        r"""
        python ./src/single_modality_classifier/models/4_01_cancer_classifier.py \
            -c {params.cancers} \
            -sm {params.modality} \
            -i {params.iteration}
        """